# Use an official Ubuntu 20.04 as a parent image
FROM ubuntu:20.04

# Set environment variables
ENV BUILD_DIR="/build"
ENV INSTALL_DIR="/usr/local"
ENV CMAKE_BUILD_TYPE="Release"
ENV TZ="Asia/Kolkata"
ENV DEBIAN_FRONTEND="noninteractive"
# Install dependencies needed for ipfixcol2
RUN ln -fs /usr/share/zoneinfo/$TZ /etc/localtime && \
echo $TZ > /etc/timezone && \apt-get update && \
    apt-get install -y \
    cmake \
    make \
    build-essential \
    libpcap-dev \
    libssl-dev \
    libprotobuf-dev \
    protobuf-compiler \
    libxml2-dev \
    liblz4-dev \
    libzstd-dev \
    git \
    pkg-config \
    python3-docutils \
    zlib1g-dev \
    librdkafka-dev \
    doxygen \
    pkg-config \
    libcurl4-openssl-dev \
    libboost-system-dev \
    libboost-filesystem-dev \
    libboost-program-options-dev \
    && rm -rf /var/lib/apt/lists/*

# Clone and build libfds (a required dependency)
RUN git clone https://github.com/CESNET/libfds.git /libfds \
    && cd /libfds \
    && mkdir -p build && cd build \
    && cmake .. -DCMAKE_INSTALL_PREFIX=/usr \
    && make \
    && make install



# Build and install ipfixcol2
RUN git clone https://github.com/CESNET/ipfixcol2.git /ipfixcol2
WORKDIR /ipfixcol2
RUN git submodule update --init --recursive && \
    cmake . -DCMAKE_INSTALL_PREFIX=/usr/local -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE \
    && make -j$(nproc) \
    && make install
COPY ./config.xml /usr/local/etc/ipfixcol2/startup.xml
WORKDIR /ipfixcol2/extra_plugins/output/clickhouse
RUN mkdir build && cd build && cmake .. && make && make install
   
WORKDIR /ipfixcol2
# Expose necessary ports for ipfixcol2
EXPOSE 4739 9995  
COPY entrypoint.sh /entrypoint.sh 
RUN chmod +x /entrypoint.sh

# Set the entrypoint
ENTRYPOINT ["/entrypoint.sh"]

#Test Change